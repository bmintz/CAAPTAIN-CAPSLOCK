#!/usr/bin/env python3

# Copyright © 2018–2019 lambda#0987
#
# CAPTAIN CAPSLOCK is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published
# by the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# CAPTAIN CAPSLOCK is distributed in the hope that it will be fun,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with CAPTAIN CAPSLOCK.  If not, see <https://www.gnu.org/licenses/>.

import functools
import itertools
from pathlib import Path

here = Path(__file__).parent
properties_path = here / 'DerivedCoreProperties.txt'

# if the amount of shadowing builtins that i do bothers you, please fix your syntax highlighter / linter

def get_derived_core_properties():
	properties = {}

	with open(properties_path) as f:
		for property_, range_ in parse_properties(f):
			properties.setdefault(property_, set()).update(map(chr, range_))

	return {property_: frozenset(chars) for property_, chars in properties.items()}

def get_derived_core_property(property_):
	desired = property_

	with open(properties_path) as f:
		for property_, range_ in parse_properties(f):
			if property_ == desired:
				yield from map(chr, range_)

def parse_properties(f):
	for line in map(str.strip, f):
		if line.startswith('#') or not line:
			continue

		# ignore trailing comments too
		line = ''.join(itertools.takewhile(lambda c: c != '#', line))

		range_, property_ = map(str.strip, line.split(';'))

		range_ = unicode_range_to_range(range_)
		yield property_, range_

def unicode_range_to_range(range_str):
	return inclusive_range(*map(hex_to_int, range_str.split('..')))

hex_to_int = functools.partial(int, base=16)

def inclusive_range(start, stop=None, step=1):
	return range_(start, start + 1 if stop is None else stop + 1, step)

def main():
	with open(here / 'derived_core_properties.py', 'w') as f:
		f.write('# generated by gen_derived_core_properties.py\n')
		f.write("DEFAULT_IGNORABLE = frozenset('")
		for c in get_derived_core_property('Default_Ignorable_Code_Point'):
			f.write(c)
		f.write("')\n")

if __name__ == '__main__':
	main()
